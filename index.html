<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#ff7a00">
<meta name="description" content="Ses komutları, yapay zeka destekli kategorizasyon ve modern arayüz ile kişisel not alma uygulaması">
<meta name="keywords" content="not, notlar, ses komutları, yapay zeka, PWA, mobil uygulama">
<meta name="author" content="Kendime">

<!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Kendime">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#ff7a00">
<meta name="msapplication-navbutton-color" content="#ff7a00">
<meta name="application-name" content="Kendime">

<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23ff7a00'/><text x='50' y='65' font-size='60' text-anchor='middle' fill='white' font-family='system-ui' font-weight='bold'>K</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23ff7a00'/><text x='90' y='125' font-size='120' text-anchor='middle' fill='white' font-family='system-ui' font-weight='bold'>K</text></svg>">

<!-- Manifest -->
<link rel="manifest" href="manifest.json">

<title>Kendime — Kişisel Not Uygulaması</title>
<style>
  :root{--accent:#ff7a00;--bg:#f7f7f7;--fg:#111;--card:#fff;--muted:#666;--border:#e9e9e9;--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
  *{box-sizing:border-box} body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg);transition:all 0.3s ease}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:15px 20px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;z-index:100;backdrop-filter:blur(10px)}
  .header-left{display:flex;justify-content:flex-start}
  .header-center{display:flex;justify-content:center}
  .header-right{display:flex;justify-content:flex-end;gap:15px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:700}
  .title{font-weight:700;color:var(--accent)}
  .search{flex:1;max-width:600px;margin:0 auto}
  .search-container{position:relative;display:flex;align-items:center;background:var(--card);border:1px solid #ddd;border-radius:24px;padding:8px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.3s ease}
  .search-container:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .search-container:focus-within{border-color:var(--accent);box-shadow:0 4px 12px rgba(255,122,0,0.2)}
  .search-icon{color:var(--muted);margin-right:12px;font-size:16px}
  .search input{flex:1;border:none;outline:none;background:transparent;font-size:16px;color:var(--fg)}
  .search input::placeholder{color:var(--muted)}
  .search-buttons{display:flex;align-items:center;gap:8px;margin-left:12px}
  .search-action-btn{background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;color:var(--muted);font-size:16px;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
  .search-action-btn:hover{background:rgba(0,0,0,0.08);color:var(--accent)}
  .search-action-btn.listening{background:var(--danger);color:white;animation:pulse 1s infinite}
  @keyframes pulse{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.1)}}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;transition:all 0.2s}
  .card:hover{box-shadow:0 4px 16px rgba(0,0,0,.1)}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}}
  input,textarea,button,select{font:inherit}
  input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;transition:all 0.2s}
  input:focus,textarea:focus,select:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(255,122,0,0.1)}
  button{padding:10px 12px;border:0;border-radius:10px;background:var(--fg);color:var(--bg);cursor:pointer;transition:all 0.2s}
  button:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.2)}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-success{background:var(--success);color:#fff}
  .btn-warning{background:var(--warning);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .light{background:#eee;color:#111}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#eee;color:#111;font-size:12px;cursor:pointer;transition:all 0.2s}
  .pill:hover{background:var(--accent);color:#fff}
  .muted{color:var(--muted)}
  .note-card{position:relative;overflow:hidden}
  .note-card.pinned{border-left:4px solid var(--accent)}
  .note-card.archived{opacity:0.6}
  .color-picker{display:flex;gap:5px;margin:8px 0}
  .color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
  .color-dot:hover,.color-dot.active{border-color:var(--fg);transform:scale(1.2)}
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:12px}
  .stat-item{text-align:center;padding:10px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
  .stat-number{font-size:24px;font-weight:700;color:var(--accent)}
  .sort-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .filter-tabs{display:flex;gap:4px;margin-bottom:12px;overflow-x:auto}
  .filter-tab{padding:8px 16px;border:1px solid var(--border);border-radius:20px;background:var(--card);cursor:pointer;transition:all 0.2s;white-space:nowrap}
  .filter-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;z-index:1000;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .modal-content{background:var(--card);border-radius:14px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
  .floating-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.2);transition:all 0.3s;z-index:99}
  .floating-btn:hover{transform:scale(1.1)}
  .speech-status{position:fixed;top:80px;right:20px;padding:10px 15px;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.1);display:none;z-index:99}
  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;font-weight:500;z-index:1001;transform:translateX(400px);transition:all 0.3s}
  .toast.show{transform:translateX(0)}
  .toast.success{background:var(--success)}
  .toast.warning{background:var(--warning)}
  .toast.danger{background:var(--danger)}
  .note-content{white-space:pre-wrap;word-break:break-word}
  .edit-mode{border:2px solid var(--accent)}
  .keyboard-shortcuts{position:fixed;bottom:10px;left:10px;font-size:12px;color:var(--muted);background:var(--card);padding:8px;border-radius:8px;border:1px solid var(--border);opacity:0.7}

  /* Menu styles */
  .menu-container{position:relative}
  .menu-btn{background:none;border:none;font-size:20px;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.2s;color:var(--muted);width:40px;height:40px;display:flex;align-items:center;justify-content:center}
  .menu-btn:hover{background:rgba(0,0,0,0.08);color:var(--accent)}
  .menu-dropdown{position:absolute;top:100%;right:0;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.1);min-width:200px;z-index:200;display:none}
  .menu-dropdown.show{display:block}
  .menu-item{padding:12px 16px;cursor:pointer;transition:all 0.2s;border-bottom:1px solid var(--border)}
  .menu-item:last-child{border-bottom:none}
  .menu-item:hover{background:var(--bg);color:var(--accent)}

  /* Settings modal styles */
  .setting-section{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--border)}
  .setting-section:last-child{border-bottom:none}
  .setting-section h4{margin:0 0 10px 0;color:var(--accent)}
  .setting-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .setting-item label{font-weight:500}
  .setting-item input[type="checkbox"]{width:auto}

  /* Help modal styles */
  .help-section{margin-bottom:15px}
  .help-section h4{color:var(--accent);margin:0 0 8px 0}
  .shortcut-list div,.voice-commands div,.mobile-tips div{padding:4px 0;font-size:14px}
  kbd{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:12px;font-family:monospace}

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .wrap{padding:8px}
    .card{padding:8px}
    .row{gap:4px}
    header{padding:10px;grid-template-columns:auto 1fr auto;gap:10px}
    .search{width:100%}
    .search-container{padding:10px 16px}
    .search input{font-size:16px}
    .search-action-btn{width:40px;height:40px;font-size:18px}
    .floating-btn{bottom:15px;right:15px;width:56px;height:56px;font-size:20px}
    .modal-content{padding:15px;width:95%}
    .filter-tabs{margin-bottom:8px}
    .filter-tab{padding:6px 12px;font-size:14px}
    .sort-controls{gap:4px;margin-bottom:8px}
    .keyboard-shortcuts{display:none}
    .toast{right:10px;top:10px;left:10px;right:10px;transform:translateY(-100px)}
    .toast.show{transform:translateY(0)}
    button{min-height:44px;padding:12px}
    input,textarea,select{min-height:44px;font-size:16px}
    .note-card{margin-bottom:8px}
    .stats{grid-template-columns:repeat(2,1fr)}
  }

  /* Touch targets */
  .color-dot{width:32px;height:32px;margin:2px}
  .pill{min-height:32px;padding:8px 12px}

  /* Swipe gestures indicator */
  .swipe-hint{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--card);padding:8px 16px;border-radius:20px;font-size:12px;color:var(--muted);border:1px solid var(--border);opacity:0.8;z-index:99}

  /* Haptic feedback simulation */
  .haptic-feedback{animation:haptic 0.1s ease}
  @keyframes haptic{0%{transform:scale(1)}50%{transform:scale(0.98)}100%{transform:scale(1)}}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <div class="logo">K</div>
  </div>
  <div class="header-center">
    <div class="title">Kendime</div>
  </div>
  <div class="header-right">
    <form class="search" onsubmit="event.preventDefault();doSearch()">
      <div class="search-container">
        <div class="search-icon">🔍</div>
        <input id="q" placeholder="Notlarda ara..." oninput="doSearch()">
        <div class="search-buttons">
          <button type="button" class="search-action-btn" onclick="toggleVoiceSearch()" title="Sesli arama">🎤</button>
          <button type="button" class="search-action-btn" onclick="openPhotoUpload()" title="Fotoğraf yükle">📷</button>
          <input type="file" id="photoUpload" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
        </div>
      </div>
    </form>
    <div class="menu-container">
      <button class="menu-btn" onclick="toggleMenu()" title="Menü">⋮</button>
      <div id="menuDropdown" class="menu-dropdown">
        <div class="menu-item" onclick="toggleTheme()">🌓 Tema değiştir</div>
        <div class="menu-item" onclick="showStats()">📊 İstatistikler</div>
        <div class="menu-item" onclick="showSettings()">⚙️ Ayarlar</div>
        <div class="menu-item" onclick="exportNotes()">💾 Dışa aktar</div>
        <div class="menu-item" onclick="document.getElementById('importFile').click()">📂 İçe aktar</div>
        <div class="menu-item" onclick="showHelp()">❓ Yardım</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Hidden Filter and Sort Controls (accessible via menu) -->
  <div id="filterControls" class="filter-controls" style="display:none">
    <div class="filter-tabs">
      <div class="filter-tab active" onclick="setFilter('all')">Tümü</div>
      <div class="filter-tab" onclick="setFilter('pinned')">📌 Sabitlenmiş</div>
      <div class="filter-tab" onclick="setFilter('archived')">📁 Arşiv</div>
      <div class="filter-tab" onclick="setFilter('recent')">🕒 Son eklenenler</div>
    </div>
    <div class="sort-controls">
      <label>Sıralama:</label>
      <select id="sortBy" onchange="render()">
        <option value="newest">En yeni</option>
        <option value="oldest">En eski</option>
        <option value="title">Başlık (A-Z)</option>
        <option value="updated">Son güncellenen</option>
      </select>
    </div>
  </div>

  <input type="file" id="importFile" accept=".json" onchange="importNotes()" style="display:none">

  <!-- Add Note Form -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <input id="title" placeholder="Başlık (Ctrl+N ile hızlı ekleme)">
      <input id="tags" placeholder="Etiketler (virgülle ayır)">
      <select id="category">
        <option value="">Kategori seçin</option>
        <option value="Kişisel">📝 Kişisel</option>
        <option value="İş">💼 İş</option>
        <option value="Fikir">💡 Fikir</option>
        <option value="Görev">✅ Görev</option>
        <option value="Önemli">⭐ Önemli</option>
      </select>
    </div>
    <textarea id="content" rows="4" placeholder="Not yaz… (Ses komutları: 'not ekle', 'temizle', 'ara')"></textarea>

    <!-- Color Picker -->
    <div class="color-picker">
      <div class="color-dot" style="background:#fff" data-color="#fff" onclick="selectColor('#fff')"></div>
      <div class="color-dot" style="background:#fef3c7" data-color="#fef3c7" onclick="selectColor('#fef3c7')"></div>
      <div class="color-dot" style="background:#fed7d7" data-color="#fed7d7" onclick="selectColor('#fed7d7')"></div>
      <div class="color-dot" style="background:#c6f6d5" data-color="#c6f6d5" onclick="selectColor('#c6f6d5')"></div>
      <div class="color-dot" style="background:#bee3f8" data-color="#bee3f8" onclick="selectColor('#bee3f8')"></div>
      <div class="color-dot" style="background:#e9d8fd" data-color="#e9d8fd" onclick="selectColor('#e9d8fd')"></div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="row">
        <button onclick="addNote()" class="btn-primary" title="Not ekle (Ctrl+Enter)">📝 Not ekle</button>
        <button class="light" onclick="clearForm()" title="Temizle (Esc)">🗑️ Temizle</button>
        <button class="voice-btn" onclick="startVoiceNote()" title="Sesli not (Ctrl+Shift+N)">🎤 Sesli Not</button>
      </div>
      <span id="count" class="muted"></span>
    </div>
  </div>

  <!-- Notes List -->
  <div id="list" class="grid"></div>
</div>

<!-- Floating Action Button -->
<button class="floating-btn" onclick="quickAdd()" title="Hızlı not (Ctrl+N)">+</button>

<!-- Speech Status -->
<div id="speechStatus" class="speech-status">
  🎤 Dinleniyor...
</div>

<!-- Statistics Modal -->
<div id="statsModal" class="modal">
  <div class="modal-content">
    <h3>📊 İstatistikler</h3>
    <div id="statsContent"></div>
    <button onclick="closeModal('statsModal')" class="light" style="margin-top:15px">Kapat</button>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>✏️ Notu Düzenle</h3>
    <input id="editTitle" placeholder="Başlık">
    <textarea id="editContent" rows="6" placeholder="İçerik"></textarea>
    <input id="editTags" placeholder="Etiketler">
    <select id="editCategory">
      <option value="">Kategori seçin</option>
      <option value="Kişisel">📝 Kişisel</option>
      <option value="İş">💼 İş</option>
      <option value="Fikir">💡 Fikir</option>
      <option value="Görev">✅ Görev</option>
      <option value="Önemli">⭐ Önemli</option>
    </select>
    <div class="row" style="margin-top:15px">
      <button onclick="saveEdit()" class="btn-success">💾 Kaydet</button>
      <button onclick="closeModal('editModal')" class="light">❌ İptal</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h3>⚙️ Uygulama Ayarları</h3>

    <div class="setting-section">
      <h4>🎨 Görünüm</h4>
      <div class="setting-item">
        <label>Tema:</label>
        <button onclick="toggleTheme()" class="light">🌓 Tema Değiştir</button>
      </div>
      <div class="setting-item">
        <label>Not kartı boyutu:</label>
        <select id="cardSize" onchange="changeCardSize()">
          <option value="small">Küçük</option>
          <option value="medium" selected>Orta</option>
          <option value="large">Büyük</option>
        </select>
      </div>
    </div>

    <div class="setting-section">
      <h4>🔊 Ses Ayarları</h4>
      <div class="setting-item">
        <label>Ses komutları:</label>
        <input type="checkbox" id="voiceEnabled" checked onchange="toggleVoiceCommands()">
      </div>
      <div class="setting-item">
        <label>Bildirim sesleri:</label>
        <input type="checkbox" id="soundEnabled" checked onchange="toggleSounds()">
      </div>
    </div>

    <div class="setting-section">
      <h4>📱 Davranış</h4>
      <div class="setting-item">
        <label>Otomatik kaydetme:</label>
        <input type="checkbox" id="autoSave" checked onchange="toggleAutoSave()">
      </div>
      <div class="setting-item">
        <label>Filtreleri göster:</label>
        <input type="checkbox" id="showFilters" onchange="toggleFilters()">
      </div>
      <div class="setting-item">
        <label>Yapay zeka önerileri:</label>
        <input type="checkbox" id="aiSuggestions" onchange="toggleAISuggestions()">
      </div>
    </div>

    <div class="setting-section">
      <h4>🗂️ Veri</h4>
      <div class="setting-item">
        <button onclick="clearAllData()" class="btn-danger">🗑️ Tüm Verileri Sil</button>
      </div>
      <div class="setting-item">
        <button onclick="exportNotes()" class="light">💾 Notları Dışa Aktar</button>
      </div>
    </div>

    <div class="row" style="margin-top:20px">
      <button onclick="closeModal('settingsModal')" class="btn-primary">✅ Tamam</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <h3>❓ Yardım & Kısayollar</h3>

    <div class="help-section">
      <h4>⌨️ Klavye Kısayolları</h4>
      <div class="shortcut-list">
        <div><kbd>Ctrl + N</kbd> - Hızlı not ekleme</div>
        <div><kbd>Ctrl + F</kbd> - Arama kutusuna odaklan</div>
        <div><kbd>Ctrl + Enter</kbd> - Not ekle</div>
        <div><kbd>Ctrl + Shift + V</kbd> - Sesli arama</div>
        <div><kbd>Esc</kbd> - Formu temizle</div>
      </div>
    </div>

    <div class="help-section">
      <h4>🎤 Ses Komutları</h4>
      <div class="voice-commands">
        <div>"not ekle" - Notu kaydet</div>
        <div>"temizle" - Formu temizle</div>
        <div>"ara [kelime]" - Kelimeyi ara</div>
        <div>"yeni not" - Hızlı not ekleme</div>
      </div>
    </div>

    <div class="help-section">
      <h4>📱 Mobil İpuçları</h4>
      <div class="mobile-tips">
        <div>• Notları sola kaydırarak silebilirsiniz</div>
        <div>• + butonuna basarak hızlı not ekleyebilirsiniz</div>
        <div>• Ses komutlarını mikrofondan kullanabilirsiniz</div>
      </div>
    </div>

    <button onclick="closeModal('helpModal')" class="btn-primary" style="margin-top:15px">Kapat</button>
  </div>
</div>

<!-- Mobile Swipe Hint -->
<div id="swipeHint" class="swipe-hint" style="display:none">
  👆 İpucu: Notları kaydırarak sil
</div>

<!-- Keyboard Shortcuts Info -->
<div class="keyboard-shortcuts">
  ⌨️ Kısayollar: Ctrl+N (Hızlı not) | Ctrl+F (Ara) | Ctrl+Shift+V (Sesli arama) | Esc (Temizle)
</div>

<script>
const KEY = "kendime_notes_v2";
let notes = JSON.parse(localStorage.getItem(KEY) || "[]");
let query = "";
let currentFilter = "all";
let selectedColor = "#fff";
let editingId = null;
let recognition = null;
let isListening = false;
let touchStartX = 0;
let touchStartY = 0;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
        console.log('SW registered successfully:', registration);

        // Update found
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showToast('Yeni güncelleme mevcut! Sayfayı yenileyin.', 'warning');
            }
          });
        });
      })
      .catch(function(registrationError) {
        console.log('SW registration failed:', registrationError);
      });
  });
}

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  if (isMobile && deferredPrompt) {
    const installBanner = document.createElement('div');
    installBanner.innerHTML = `
      <div style="position:fixed;bottom:80px;left:10px;right:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;z-index:999;box-shadow:0 4px 16px rgba(0,0,0,0.1)">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600">📱 Uygulamayı Yükle</div>
            <div style="font-size:12px;color:var(--muted)">Ana ekranına ekle</div>
          </div>
          <div class="row" style="gap:8px">
            <button onclick="installPWA()" class="btn-primary" style="padding:8px 12px;font-size:12px">Yükle</button>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="light" style="padding:8px 12px;font-size:12px">✕</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(installBanner);

    setTimeout(() => {
      if (installBanner.parentElement) {
        installBanner.remove();
      }
    }, 10000);
  }
}

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        showToast('Uygulama yükleniyor! 📱', 'success');
      }
      deferredPrompt = null;
    });
  }
}

// Initialize speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'tr-TR';

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.toLowerCase();
    handleVoiceCommand(transcript);
  };

  recognition.onerror = function(event) {
    showToast('Ses tanıma hatası: ' + event.error, 'danger');
    hideVoiceStatus();
  };

  recognition.onend = function() {
    isListening = false;
    hideVoiceStatus();
    updateVoiceButton();
  };
}

// Note: Debounced save for localStorage optimization.
let saveTimeout;
function save() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    localStorage.setItem(KEY, JSON.stringify(notes));
  }, 300); // 300ms bekle
}

// Immediate save for specific actions if needed.
function saveNow() {
  clearTimeout(saveTimeout);
  localStorage.setItem(KEY, JSON.stringify(notes));
}

function uid() { 
  return Date.now().toString(36) + Math.random().toString(36).slice(2); 
}

function formatDate(timestamp) {
  return new Date(timestamp).toLocaleDateString('tr-TR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function escape(s) {
  return s.replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[m]));
}

// Note management
function addNote() {
  const t = title.value.trim();
  const c = content.value.trim();
  const g = tags.value.trim();
  const cat = category.value;

  if (!t && !c) {
    showToast("Boş not eklenemez", "warning");
    return;
  }

  // Add haptic feedback for mobile
  addHapticFeedback(event?.target);

  const note = {
    id: uid(),
    title: t,
    content: c,
    tags: g,
    category: cat,
    pinned: false,
    archived: false,
    color: selectedColor,
    ts: Date.now(),
    updated: Date.now()
  };

  notes.unshift(note);
  clearForm();
  save();
  showToast("Not eklendi! 📝", "success");
}

function editNote(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;

  editingId = id;
  document.getElementById('editTitle').value = note.title || '';
  document.getElementById('editContent').value = note.content || '';
  document.getElementById('editTags').value = note.tags || '';
  document.getElementById('editCategory').value = note.category || '';

  showModal('editModal');
}

function saveEdit() {
  if (!editingId) return;

  const note = notes.find(n => n.id === editingId);
  if (!note) return;

  note.title = document.getElementById('editTitle').value.trim();
  note.content = document.getElementById('editContent').value.trim();
  note.tags = document.getElementById('editTags').value.trim();
  note.category = document.getElementById('editCategory').value;
  note.updated = Date.now();

  save();
  closeModal('editModal');
  showToast("Not güncellendi! ✅", "success");
  editingId = null;
}

function removeNote(id) {
  if (confirm('Bu notu silmek istediğinizden emin misiniz?')) {
    notes = notes.filter(n => n.id !== id);
    save();
    showToast("Not silindi! 🗑️", "success");
  }
}

function togglePin(id) {
  const note = notes.find(n => n.id === id);
  if (note) {
    note.pinned = !note.pinned;
    note.updated = Date.now();
    save();
    showToast(note.pinned ? "Not sabitlendi! 📌" : "Not sabitleme kaldırıldı!", "success");
  }
}

function toggleArchive(id) {
  const note = notes.find(n => n.id === id);
  if (note) {
    note.archived = !note.archived;
    note.updated = Date.now();
    save();
    showToast(note.archived ? "Not arşivlendi! 📁" : "Not arşivden çıkarıldı!", "success");
  }
}

function duplicateNote(id) {
  const note = notes.find(n => n.id === id);
  if (note) {
    const newNote = {
      ...note,
      id: uid(),
      title: (note.title || '') + ' (Kopya)',
      ts: Date.now(),
      updated: Date.now()
    };
    notes.unshift(newNote);
    save();
    showToast("Not kopyalandı! 📋", "success");
  }
}

function clearForm() {
  title.value = "";
  content.value = "";
  tags.value = "";
  category.value = "";
  selectedColor = "#fff";
  updateColorPicker();
}

function selectColor(color) {
  selectedColor = color;
  updateColorPicker();
}

function updateColorPicker() {
  document.querySelectorAll('.color-dot').forEach(dot => {
    dot.classList.toggle('active', dot.dataset.color === selectedColor);
  });
}

// Search and filter
function doSearch() {
  query = q.value.toLowerCase();
  render();
}

function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
  render();
}

// Voice commands
function handleVoiceCommand(transcript) {
  hideVoiceStatus();

  if (transcript.includes('not ekle') || transcript.includes('kaydet')) {
    addNote();
  } else if (transcript.includes('temizle') || transcript.includes('sil')) {
    clearForm();
    showToast("Form temizlendi! 🗑️", "success");
  } else if (transcript.includes('ara') || transcript.includes('bul')) {
    const searchTerm = transcript.replace(/ara|bul/g, '').trim();
    if (searchTerm) {
      document.getElementById('q').value = searchTerm;
      doSearch();
      showToast(`"${searchTerm}" aranıyor...`, "success");
    }
  } else if (transcript.includes('yeni not')) {
    quickAdd();
  } else if (transcript.includes('tümü') || transcript.includes('hepsi')) {
    setFilter('all');
  } else if (transcript.includes('sabitle') || transcript.includes('pin')) {
    showToast("Hangi notu sabitlemek istediğinizi belirtin", "warning");
  } else {
    // If no command recognized, use as note content
    content.value = transcript;
    showToast("Ses metne dönüştürüldü! ✍️", "success");
  }
}

function startVoiceNote() {
  if (!recognition) {
    showToast("Ses tanıma bu tarayıcıda desteklenmiyor", "danger");
    return;
  }

  if (isListening) {
    recognition.stop();
    return;
  }

  isListening = true;
  showVoiceStatus();
  updateVoiceButton();
  recognition.start();
}

function toggleVoiceSearch() {
  if (!recognition) {
    showToast("Ses tanıma bu tarayıcıda desteklenmiyor", "danger");
    return;
  }

  if (isListening) {
    recognition.stop();
    return;
  }

  isListening = true;
  showVoiceStatus();
  updateVoiceButton();

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById('q').value = transcript;
    doSearch();
    showToast(`"${transcript}" aranıyor...`, "success");
  };

  recognition.start();
}

function openPhotoUpload() {
  document.getElementById('photoUpload').click();
}

function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!file.type.startsWith('image/')) {
    showToast("Lütfen geçerli bir resim dosyası seçin", "danger");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const imageData = e.target.result;

    // Create a note with the image
    const note = {
      id: uid(),
      title: `Fotoğraf - ${file.name}`,
      content: `Fotoğraf yüklendi: ${file.name}\nBoyut: ${(file.size / 1024).toFixed(1)} KB`,
      tags: "fotoğraf,resim",
      category: "Medya",
      pinned: false,
      archived: false,
      color: selectedColor,
      image: imageData,
      ts: Date.now(),
      updated: Date.now()
    };

    notes.unshift(note);
    save();
    showToast("Fotoğraf eklendi! 📷", "success");

    // Clear the file input
    event.target.value = '';

    // Refresh the view
    render();
  };

  reader.readAsDataURL(file);
}

function updateVoiceButton() {
  document.querySelectorAll('.search-action-btn').forEach(btn => {
    if (btn.textContent.includes('🎤')) {
      btn.classList.toggle('listening', isListening);
    }
  });
}

function showVoiceStatus() {
  document.getElementById('speechStatus').style.display = 'block';
}

function hideVoiceStatus() {
  document.getElementById('speechStatus').style.display = 'none';
}

// UI functions
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

function showModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function quickAdd() {
  document.getElementById('title').focus();
  showToast("Hızlı not ekleme! ⚡", "success");
}

// Statistics
function showStats() {
  const total = notes.length;
  const pinned = notes.filter(n => n.pinned).length;
  const archived = notes.filter(n => n.archived).length;
  const categories = {};
  const tagStats = {};

  notes.forEach(note => {
    if (note.category) {
      categories[note.category] = (categories[note.category] || 0) + 1;
    }
    if (note.tags) {
      note.tags.split(',').forEach(tag => {
        const cleanTag = tag.trim();
        if (cleanTag) {
          tagStats[cleanTag] = (tagStats[cleanTag] || 0) + 1;
        }
      });
    }
  });

  const topTags = Object.entries(tagStats)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5);

  document.getElementById('statsContent').innerHTML = `
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number">${total}</div>
        <div>Toplam Not</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">${pinned}</div>
        <div>Sabitlenmiş</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">${archived}</div>
        <div>Arşivlenmiş</div>
      </div>
    </div>

    <h4>📊 Kategoriler</h4>
    ${Object.entries(categories).map(([cat, count]) => 
      `<div class="row" style="justify-content:space-between;margin:5px 0">
        <span>${cat}</span><span class="pill">${count}</span>
      </div>`
    ).join('') || '<p class="muted">Henüz kategori yok</p>'}

    <h4>🏷️ En Çok Kullanılan Etiketler</h4>
    ${topTags.map(([tag, count]) => 
      `<div class="row" style="justify-content:space-between;margin:5px 0">
        <span>${tag}</span><span class="pill">${count}</span>
      </div>`
    ).join('') || '<p class="muted">Henüz etiket yok</p>'}
  `;

  showModal('statsModal');
}

// Import/Export
function exportNotes() {
  const dataStr = JSON.stringify(notes, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `kendime-notlar-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
  showToast("Notlar dışa aktarıldı! 💾", "success");
}

function importNotes() {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedNotes = JSON.parse(e.target.result);
      if (Array.isArray(importedNotes)) {
        notes = [...importedNotes, ...notes];
        save();
        showToast(`${importedNotes.length} not içe aktarıldı! 📂`, "success");
      } else {
        showToast("Geçersiz dosya formatı", "danger");
      }
    } catch (error) {
      showToast("Dosya okuma hatası", "danger");
    }
  };
  reader.readAsText(file);
}

// Theme
function toggleTheme() {
  const dark = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() === '#121212';
  if (dark) {
    setVars('#f7f7f7', '#111', '#fff', '#666', '#e9e9e9');
  } else {
    setVars('#121212', '#eee', '#1e1e1e', '#aaa', '#333');
  }
  showToast(dark ? "Açık tema! ☀️" : "Koyu tema! 🌙", "success");
}

function setVars(bg, fg, card, muted, border) {
  const root = document.documentElement.style;
  root.setProperty('--bg', bg);
  root.setProperty('--fg', fg);
  root.setProperty('--card', card);
  root.setProperty('--muted', muted);
  root.setProperty('--border', border);
}

// Render
function render() {
  const list = document.getElementById("list");
  let filtered = notes.filter(n => {
    const searchMatch = !query || (n.title + " " + n.content + " " + (n.tags || "") + " " + (n.category || ""))
      .toLowerCase().includes(query);

    switch (currentFilter) {
      case 'pinned': return searchMatch && n.pinned && !n.archived;
      case 'archived': return searchMatch && n.archived;
      case 'recent': return searchMatch && !n.archived && (Date.now() - n.ts < 7 * 24 * 60 * 60 * 1000);
      default: return searchMatch && !n.archived;
    }
  });

  // Sorting
  const sortBy = document.getElementById('sortBy').value;
  filtered.sort((a, b) => {
    if (a.pinned !== b.pinned) return b.pinned - a.pinned;

    switch (sortBy) {
      case 'oldest': return a.ts - b.ts;
      case 'title': return (a.title || '').localeCompare(b.title || '');
      case 'updated': return b.updated - a.updated;
      default: return b.ts - a.ts;
    }
  });

  document.getElementById('count').textContent = `${filtered.length} not`;

  list.innerHTML = filtered.map(n => `
    <div class="card note-card ${n.pinned ? 'pinned' : ''} ${n.archived ? 'archived' : ''}" 
         style="background:${n.color || '#fff'}">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="row">
          ${n.category ? `<span class="pill">${n.category}</span>` : ''}
          ${(n.tags || '').split(',').filter(t => t.trim()).slice(0, 2).map(tag => 
            `<span class="pill" onclick="searchTag('${tag.trim()}')">${tag.trim()}</span>`
          ).join('')}
        </div>
        <div class="row">
          <button class="light" onclick="togglePin('${n.id}')" title="${n.pinned ? 'Sabitlemeyi kaldır' : 'Sabitle'}">
            ${n.pinned ? '📌' : '📍'}
          </button>
          <button class="light" onclick="editNote('${n.id}')" title="Düzenle">✏️</button>
          <button class="light" onclick="duplicateNote('${n.id}')" title="Kopyala">📋</button>
          <button class="light" onclick="toggleArchive('${n.id}')" title="${n.archived ? 'Arşivden çıkar' : 'Arşivle'}">
            ${n.archived ? '📤' : '📁'}
          </button>
          <button class="light" onclick="removeNote('${n.id}')" title="Sil">🗑️</button>
        </div>
      </div>

      <h4 style="margin:.3rem 0">${escape(n.title || 'Başlıksız')}</h4>
      ${n.image ? `<img src="${n.image}" style="max-width:100%;height:auto;border-radius:8px;margin:8px 0;" alt="Yüklenen resim">` : ''}
      <div class="note-content muted">${escape(n.content).slice(0, 200)}${n.content.length > 200 ? '...' : ''}</div>

      <div class="row" style="justify-content:space-between;margin-top:8px;font-size:12px">
        <span class="muted">📅 ${formatDate(n.ts)}</span>
        ${n.updated !== n.ts ? `<span class="muted">✏️ ${formatDate(n.updated)}</span>` : ''}
      </div>
    </div>
  `).join('');
}

function searchTag(tag) {
  document.getElementById('q').value = tag;
  doSearch();
  showToast(`"${tag}" etiketiyle arama yapılıyor...`, "success");
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl+N - Quick add
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    quickAdd();
  }

  // Ctrl+F - Focus search
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    document.getElementById('q').focus();
  }

  // Ctrl+Shift+V - Voice search
  if (e.ctrlKey && e.shiftKey && e.key === 'V') {
    e.preventDefault();
    toggleVoiceSearch();
  }

  // Ctrl+Shift+N - Voice note
  if (e.ctrlKey && e.shiftKey && e.key === 'N') {
    e.preventDefault();
    startVoiceNote();
  }

  // Ctrl+Enter - Add note
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    addNote();
  }

  // Escape - Clear form
  if (e.key === 'Escape') {
    clearForm();
  }
});

// Touch swipe functionality
document.addEventListener('touchstart', function(e) {
  if (e.target.closest('.note-card')) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }
}, { passive: true });

document.addEventListener('touchend', function(e) {
  if (!e.target.closest('.note-card')) return;

  const touchEndX = e.changedTouches[0].clientX;
  const touchEndY = e.changedTouches[0].clientY;
  const deltaX = touchStartX - touchEndX;
  const deltaY = Math.abs(touchStartY - touchEndY);

  // Horizontal swipe with minimum distance and not too much vertical movement
  if (Math.abs(deltaX) > 100 && deltaY < 50) {
    const noteCard = e.target.closest('.note-card');
    const noteId = noteCard.querySelector('[onclick*="removeNote"]')?.onclick.toString().match(/'([^']+)'/)?.[1];

    if (deltaX > 0 && noteId) { // Swipe left to delete
      noteCard.classList.add('haptic-feedback');
      setTimeout(() => {
        if (confirm('Bu notu silmek istediğinizden emin misiniz?')) {
          removeNote(noteId);
        }
      }, 100);
    }
  }
}, { passive: true });

// Haptic feedback for mobile
function addHapticFeedback(element) {
  if (isMobile && 'vibrate' in navigator) {
    navigator.vibrate(10);
  }
  if (element) {
    element.classList.add('haptic-feedback');
    setTimeout(() => element.classList.remove('haptic-feedback'), 100);
  }
}

// Enhanced mobile voice recognition
if (isMobile && recognition) {
  recognition.continuous = true; // Better for mobile
  recognition.interimResults = true;

  let interimTranscript = '';
  recognition.onresult = function(event) {
    let finalTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interimTranscript = event.results[i][0].transcript;
      }
    }

    if (finalTranscript) {
      handleVoiceCommand(finalTranscript.toLowerCase());
    }

    // Show interim results
    if (interimTranscript && document.getElementById('speechStatus').style.display === 'block') {
      document.getElementById('speechStatus').innerHTML = `🎤 "${interimTranscript}"`;
    }
  };
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});

// Show swipe hint on mobile
if (isMobile && notes.length > 0) {
  setTimeout(() => {
    const hint = document.getElementById('swipeHint');
    hint.style.display = 'block';
    setTimeout(() => {
      hint.style.display = 'none';
    }, 3000);
  }, 2000);
}

// Menu functions
function toggleMenu() {
  const dropdown = document.getElementById('menuDropdown');
  dropdown.classList.toggle('show');
}

function showSettings() {
  closeMenu();
  showModal('settingsModal');
}

function showHelp() {
  closeMenu();
  showModal('helpModal');
}

function closeMenu() {
  document.getElementById('menuDropdown').classList.remove('show');
}

// Settings functions
function changeCardSize() {
  const size = document.getElementById('cardSize').value;
  const root = document.documentElement.style;

  switch(size) {
    case 'small':
      root.setProperty('--card-min-width', '250px');
      break;
    case 'large':
      root.setProperty('--card-min-width', '400px');
      break;
    default:
      root.setProperty('--card-min-width', '300px');
  }

  showToast(`Kart boyutu ${size} olarak ayarlandı`, 'success');
}

function toggleVoiceCommands() {
  const enabled = document.getElementById('voiceEnabled').checked;
  showToast(enabled ? 'Ses komutları etkinleştirildi' : 'Ses komutları devre dışı bırakıldı', 'success');
}

function toggleSounds() {
  const enabled = document.getElementById('soundEnabled').checked;
  showToast(enabled ? 'Bildirim sesleri etkinleştirildi' : 'Bildirim sesleri kapatıldı', 'success');
}

function toggleAutoSave() {
  const enabled = document.getElementById('autoSave').checked;
  showToast(enabled ? 'Otomatik kaydetme etkinleştirildi' : 'Otomatik kaydetme kapatıldı', 'success');
}

function toggleFilters() {
  const enabled = document.getElementById('showFilters').checked;
  const filterControls = document.getElementById('filterControls');
  filterControls.style.display = enabled ? 'block' : 'none';
  showToast(enabled ? 'Filtreler gösteriliyor' : 'Filtreler gizlendi', 'success');
}

function toggleAISuggestions() {
  const enabled = document.getElementById('aiSuggestions').checked;
  showToast(enabled ? 'AI önerileri etkinleştirildi' : 'AI önerileri kapatıldı', 'success');
}

function clearAllData() {
  if (confirm('Tüm notlarınız silinecek! Bu işlem geri alınamaz. Emin misiniz?')) {
    if (confirm('Son kez soruyorum: Gerçekten tüm verileri silmek istiyor musunuz?')) {
      notes = [];
      localStorage.removeItem(KEY);
      render();
      showToast('Tüm veriler silindi! 🗑️', 'warning');
      closeModal('settingsModal');
    }
  }
}

// Close menu when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.menu-container')) {
    closeMenu();
  }
});

// Initialize
updateColorPicker();
render();

// Welcome message
if (notes.length === 0) {
  showToast("Kendime'ye hoş geldiniz! 🎉 İlk notunuzu ekleyin.", "success");
}
</script>
</body>
</html>